import{defineComponent as I,ref as P,reactive as L,onMounted as z,resolveComponent as p,resolveDirective as R,openBlock as a,createElementBlock as m,withDirectives as j,createBlock as c,withCtx as f,createVNode as _,unref as g,withKeys as y,Fragment as h,renderList as E,withModifiers as w,createElementVNode as U,toDisplayString as F,createCommentVNode as b,createTextVNode as O}from"vue";import{F as T}from"./index-39d73c69.js";import{_ as Q,i as H,p as J,d as W,a as X}from"./add.vue_vue_type_script_setup_true_lang-a8af4230.js";import{ElForm as Y,ElNotification as Z,ElMessageBox as ee}from"element-plus";import{r as te}from"./router-fdf560e7.js";import{b as oe}from"./validate-e09b6b50.js";import{u as ne,h as ae,i as A,_ as re}from"./index-89e26330.js";import{useI18n as le}from"vue-i18n";import"./index-0a827c2c.js";import"vue-router";import"./controllerUrls-941681c3.js";import"./index-d3b20950.js";import"./memberCenter-893be883.js";import"pinia";import"vue-demi";const ie={class:"default-main"},se={class:"config-form-item"},de={class:"config-form-item-name"},ue={class:"del-config-form-item"},ce={key:0,class:"send-test-mail"},fe=["onClick"],pe=I({name:"routine/config"}),me=I({...pe,setup(_e){const{t:s}=le(),C=ne();ae();const v=P(),e=L({loading:!0,config:[],remark:"",configGroup:{},activeTab:"",showAddForm:!1,rules:{},form:{},quickEntrance:{},formKey:A()}),K=()=>{H().then(l=>{e.config=l.data.list,e.remark=l.data.remark,e.configGroup=l.data.configGroup,e.quickEntrance=l.data.quickEntrance,e.loading=!1;for(const o in e.configGroup){e.activeTab=o;break}let n={},r={};for(const o in e.config)for(const i in e.config[o].list){if(e.config[o].list[i].rule){let x=e.config[o].list[i].rule.split(","),k=[];x.forEach(V=>{k.push(oe({name:V,title:e.config[o].list[i].title}))}),r=Object.assign(r,{[e.config[o].list[i].name]:k})}n[e.config[o].list[i].name]=e.config[o].list[i].type=="number"?parseFloat(e.config[o].list[i].value):e.config[o].list[i].value}e.form=n,e.rules=r,e.formKey=A()}).catch(()=>{e.loading=!1})},D=l=>{if(l=="add_config")return e.showAddForm=!0,!1},$=l=>{l&&l.validate(n=>{if(n){const r={};for(const o in e.config)if(o==e.activeTab)for(const i in e.config[o].list)r[e.config[o].list[i].name]=e.form[e.config[o].list[i].name]??"";J("edit",r).then(()=>{for(const o in C.$state)r[o]&&C.$state[o]!=r[o]&&(C.$state[o]=r[o])})}})},M=l=>{W([l.id]).then(()=>{K()})},S=()=>{if(!e.form.smtp_server||!e.form.smtp_port||!e.form.smtp_user||!e.form.smtp_pass||!e.form.smtp_sender_mail)return Z({type:"error",message:s("routine.config.Please enter the correct mail configuration")}),!1;ee.prompt(s("routine.config.Please enter the recipient email address"),s("routine.config.Test mail sending"),{confirmButtonText:s("routine.config.send out"),cancelButtonText:s("Cancel"),inputPattern:/[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/,inputErrorMessage:s("routine.config.Please enter the correct email address"),beforeClose:(l,n,r)=>{l==="confirm"?(n.confirmButtonLoading=!0,n.confirmButtonText=s("routine.config.Sending"),X(e.form,n.inputValue).then(o=>{r()}).catch(o=>{r()})):r()}})};return z(()=>{K()}),(l,n)=>{const r=p("Icon"),o=p("el-popconfirm"),i=p("el-button"),x=p("el-tab-pane"),k=p("el-tabs"),V=p("el-col"),N=p("el-card"),q=p("el-row"),G=R("loading");return a(),m("div",ie,[j((a(),c(q,{gutter:20},{default:f(()=>[_(V,{class:"xs-mb-20",xs:24,sm:16},{default:f(()=>[e.loading?b("",!0):(a(),c(g(Y),{ref_key:"formRef",ref:v,onKeyup:n[6]||(n[6]=y(d=>$(v.value),["enter"])),model:e.form,rules:e.rules,"label-position":"top",key:e.formKey},{default:f(()=>[_(k,{modelValue:e.activeTab,"onUpdate:modelValue":n[5]||(n[5]=d=>e.activeTab=d),type:"border-card","before-leave":D},{default:f(()=>[(a(!0),m(h,null,E(e.config,(d,B)=>(a(),c(x,{class:"config-tab-pane",key:B,name:B,label:d.title},{default:f(()=>[(a(!0),m(h,null,E(d.list,(t,ge)=>(a(),m("div",se,[t.group==e.activeTab?(a(),m(h,{key:0},[t.type=="number"?(a(),c(T,{label:t.title,type:t.type,modelValue:e.form[t.name],"onUpdate:modelValue":u=>e.form[t.name]=u,modelModifiers:{number:!0},attr:{prop:t.name,...t.extend},"input-attr":{placeholder:t.tip,...t.input_extend},data:{tip:t.tip},key:"number-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","data"])):t.type=="editor"?(a(),c(T,{label:t.title,type:t.type,onKeyup:[n[0]||(n[0]=y(w(()=>{},["stop"]),["enter"])),n[1]||(n[1]=y(w(u=>$(v.value),["ctrl"]),["enter"]))],modelValue:e.form[t.name],"onUpdate:modelValue":u=>e.form[t.name]=u,attr:{prop:t.name,...t.extend},"input-attr":{placeholder:t.tip,style:{zIndex:99},...t.input_extend},data:{tip:t.tip},key:"editor-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","data"])):t.type=="textarea"?(a(),c(T,{label:t.title,type:t.type,onKeyup:[n[2]||(n[2]=y(w(()=>{},["stop"]),["enter"])),n[3]||(n[3]=y(w(u=>$(v.value),["ctrl"]),["enter"]))],modelValue:e.form[t.name],"onUpdate:modelValue":u=>e.form[t.name]=u,attr:{prop:t.name,...t.extend},"input-attr":{placeholder:t.tip,rows:3,...t.input_extend},data:{tip:t.tip},key:"textarea-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","data"])):(a(),c(T,{label:t.title,type:t.type,modelValue:e.form[t.name],"onUpdate:modelValue":u=>e.form[t.name]=u,attr:{prop:t.name,...t.extend},"input-attr":{placeholder:t.tip,...t.input_extend},data:{tip:t.tip,content:t.content?t.content:{}},key:"other-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","data"])),U("div",de,"$"+F(t.name),1),U("div",ue,[t.allow_del?(a(),c(o,{key:0,onConfirm:u=>M(t),confirmButtonText:g(s)("delete"),title:g(s)("routine.config.Are you sure to delete the configuration item?")},{reference:f(()=>[_(r,{class:"close-icon",size:"15",name:"el-icon-Close"})]),_:2},1032,["onConfirm","confirmButtonText","title"])):b("",!0)])],64)):b("",!0)]))),256)),d.name=="mail"?(a(),m("div",ce,[_(i,{onClick:n[4]||(n[4]=t=>S())},{default:f(()=>[O(F(g(s)("routine.config.Test mail sending")),1)]),_:1})])):b("",!0)]),_:2},1032,["name","label"]))),128)),_(x,{name:"add_config",class:"config-tab-pane config-tab-pane-add",label:g(s)("routine.config.Add configuration item")},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["model","rules"]))]),_:1}),_(V,{xs:24,sm:8},{default:f(()=>[_(N,{header:g(s)("routine.config.Quick configuration entry")},{default:f(()=>[(a(!0),m(h,null,E(e.quickEntrance,d=>(a(),c(i,{class:"config_quick_entrance"},{default:f(()=>[U("div",{onClick:B=>g(te)(d.value)},F(d.key),9,fe)]),_:2},1024))),256))]),_:1},8,["header"])]),_:1})]),_:1})),[[G,e.loading]]),e.loading?b("",!0):(a(),c(Q,{key:0,modelValue:e.showAddForm,"onUpdate:modelValue":n[7]||(n[7]=d=>e.showAddForm=d),"config-group":e.configGroup},null,8,["modelValue","config-group"]))])}}});const Ke=re(me,[["__scopeId","data-v-336f39b4"]]);export{Ke as default};
